# Supabase Setup Guide for RehearseAI

This guide walks you through setting up the necessary resources in your Supabase project to make the RehearseAI application work correctly.

## 1. Create the Storage Bucket

1. Log in to your [Supabase Dashboard](https://app.supabase.co) and select your project
2. Navigate to **Storage** in the left sidebar
3. Click **Create bucket**
4. Enter the name: `interview-recordings`
5. Make sure to check the option **Public bucket** (so videos can be viewed)
6. Click **Create bucket**

## 2. Set Up Storage Bucket RLS Policies

After creating the bucket, you need to set up Row Level Security policies:

1. In the Supabase Dashboard, go to **Storage** > **Policies**
2. Click on the **interview-recordings** bucket
3. Add the following policies:

### Policy 1: Allow authenticated uploads
- **Name**: Allow authenticated uploads
- **For table**: objects
- **Operation**: INSERT
- **Target roles**: authenticated
- **Using expression**:
  ```sql
  (bucket_id = 'interview-recordings')
  ```

### Policy 2: Allow users to view/update/delete their own files
- **Name**: Allow users to manage their own files
- **For table**: objects
- **Operation**: SELECT, UPDATE, DELETE
- **Target roles**: authenticated
- **Using expression**:
  ```sql
  (bucket_id = 'interview-recordings')
  ```

### Policy 3: Allow public read access
- **Name**: Allow public read access
- **For table**: objects
- **Operation**: SELECT
- **Target roles**: public (anonymous)
- **Using expression**:
  ```sql
  (bucket_id = 'interview-recordings')
  ```

## 3. Create the Database Table

1. Go to the **SQL Editor** in the Supabase Dashboard
2. Paste the following SQL and execute it:

```sql
-- Create table for practice sessions
CREATE TABLE IF NOT EXISTS practice_sessions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  question TEXT NOT NULL,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  notes TEXT DEFAULT '',
  video_url TEXT NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE
);

-- Add row level security
ALTER TABLE practice_sessions ENABLE ROW LEVEL SECURITY;

-- Allow users to view their own sessions
CREATE POLICY "Users can view their own practice sessions"
  ON practice_sessions
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

-- Allow users to insert their own sessions
CREATE POLICY "Users can insert their own practice sessions"
  ON practice_sessions
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = user_id);

-- Allow users to update their own sessions
CREATE POLICY "Users can update their own practice sessions"
  ON practice_sessions
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = user_id);

-- Allow users to delete their own sessions
CREATE POLICY "Users can delete their own practice sessions"
  ON practice_sessions
  FOR DELETE
  TO authenticated
  USING (auth.uid() = user_id);

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_practice_sessions_user_id 
  ON practice_sessions (user_id);
```

## 4. Testing Your Setup

After completing these steps, test your setup:

1. Run the connection test to verify Supabase connectivity:
   ```
   npm run test:supabase
   ```

2. Run your application and navigate to the practice page:
   ```
   npm run dev
   ```

3. Go to http://localhost:3000/practice and try recording and saving a video.

## Troubleshooting

If you encounter any issues:

1. Check the browser console for any errors
2. Verify that your Supabase URL and anon key are correctly set in your `.env.local` file
3. Ensure you're logged in to the application before trying to save recordings
4. Check that both the storage bucket and database table have been properly created 